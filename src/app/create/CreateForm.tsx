'use client'

import { useState } from "react";
import {Flashcard} from "@/types/flashcard";
import NewFlashcard from "@/app/create/NewFlashcard";
import {Button, IconButton, TextField} from "@mui/material";
import AddIcon from '@mui/icons-material/Add';
import ArrowBackIcon from '@mui/icons-material/ArrowBack';
import ArrowForwardIcon from '@mui/icons-material/ArrowForward';
import {createClient} from "@/utils/supabase/client"
import {useRouter} from "next/navigation";
import "@/app/globals.css"

export default function CreateForm() {
    const [cards, setCards] = useState<Flashcard[]>([{id: 0, front: "", back: ""}]);
    const [nextID, setNextID] = useState(1);
    const [index, setIndex] = useState(0)
    const [stackName, setStackName] = useState("")
    const [autoTranslate, setAutoTranslate] = useState(true)
    const supabase = createClient()
    const router = useRouter()


    const addCard = () => {
        setCards(prev => [
            ...prev,
            { id: nextID, front: "", back: "" }
        ]);
        setNextID(nextID => nextID + 1)
        setIndex(index => index + 1)
    };

    const updateCard = (id: number, changes: Partial<Flashcard>) => {
        setCards(prev =>
            prev.map(card =>
                card.id == id ? { ...card, ...changes } : card
            )
        );
    };

    const deleteCard = (id: number) => {
        setCards(prev => prev.filter(card => card.id !== id));
    };

    const saveStack = async () => {
        const {
            data: {user}
        } = await supabase.auth.getUser()

        //save the flashcard stack object first
        const {data, error} = await supabase
            .from('flashcard_sets')
            .insert([
                {
                    user_id: user!.id,
                    //stack_id automatically generated by supabase
                    stack_name: stackName
                }
            ])
            .select('stack_id')

        //save each flashcard in the stack
        for (const card of cards) {
            await supabase
                .from('flashcards')
                .insert([
                    {
                        stack_id: data![0].stack_id,
                        front: card.front,
                        back: card.back
                    }
                ])
        }

        //redirect user to home page
        router.push("/")

    }

    return (
        <div className="grid grid-cols-4 grid-rows-4 w-screen h-screen">
            <TextField
                value={stackName}
                onChange={(e) => setStackName(e.target.value)}
                placeholder="Stack name"
                className={"col-span-2 col-start-2 row-span-1 row-start-1"}
                fullWidth={true}
            />
            <div
                className={"col-span-2 col-start-2 row-span-2 row-start-2"}>
                <NewFlashcard
                    key={cards[index].id}
                    card={cards[index]}
                    onUpdate={updateCard}
                    onDelete={deleteCard}
                />
            </div>
            {index !== 0 &&
                <IconButton
                    onClick={() => setIndex(index => index - 1)}
                    className={"row-start-2 row-span-2 col-start-1 col-span-1 w-fit h-fit self-center justify-self-center"}
                >
                    <ArrowBackIcon sx={{ fontSize: 40 }}/>
                </IconButton>
            }
            {index === cards.length - 1 ?
                <IconButton
                    onClick={addCard}
                    className={"row-start-2 row-span-2 col-start-4 col-span-1 w-fit h-fit self-center justify-self-center"}
                >
                    <AddIcon sx={{ fontSize: 40 }}/>
                </IconButton> :
                <IconButton
                    onClick={() => setIndex(index => index + 1)}
                    className={"row-start-2 row-span-2 col-start-4 col-span-1 w-fit h-fit self-center justify-self-center"}
                >
                    <ArrowForwardIcon sx={{ fontSize: 40 }}/>
                </IconButton>
            }
            {autoTranslate ?
                <Button
                    className={"row-start-4 row-span-1 col-start-1 col-span-1 w-fit h-fit self-center justify-self-center"}
                    variant="contained"
                    sx={{
                        backgroundColor: '#6a1b9a', // custom color
                        '&:hover': {
                            backgroundColor: '#4a148c', // darker on hover
                        },
                    }}
                    onClick={() => setAutoTranslate(false)}
                >
                    Auto-translate enabled
                </Button> :
                <Button
                    className={"row-start-4 row-span-1 col-start-1 col-span-1 w-fit h-fit self-center justify-self-center"}
                    variant="contained"
                    sx={{ backgroundColor: 'royal_blue', color: '#fff' }}
                    onClick={() => setAutoTranslate(true)}
                >
                    Auto-translate disabled
                </Button>
            }

            <Button
                onClick={saveStack}
                className={"row-start-4 row-span-1 col-start-4 col-span-4 w-fit h-fit self-center justify-self-center"}
                variant="contained"
                sx={{ backgroundColor: 'royal_blue', color: '#fff' }}
            >
                Save flashcard Set
            </Button>
        </div>
    );
}
